"use strict";exports.__esModule=!0;var es6_promise_1=require("es6-promise"),chokidar=require("chokidar"),crypto=require("crypto"),fs=require("fs"),glob=require("glob"),path=require("path"),yargs=require("yargs"),args=yargs.describe("ext","File extension used for index files and internal filter").describe("name","File name used for the index files").describe("watch","Enables watch mode").argv;function compareContents(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var t=!0;if(e.length){var i=getHash(e[0]);e.slice(1).forEach(function(e){i!=getHash(e)&&t&&(t=!1)})}return t}function createContents(e){var n="";if(e.length){var t=e.filter(function(e){return!0===e.isIndex});n=e.reduce(function(e,n){return e+(n.isIndex?"import * as "+n.name+" from './"+n.name+"';\r\n":"export { default as "+n.name+" } from './"+n.name+"';\r\n")},n),t.length&&(n=n+"export { "+t.map(function(e){return e.name}).join(", ")+" }\r\n")}return n}function createFile(n,o){getModules(n,o,function(e){var t=path.join(path.dirname(n),o.fileName+"."+o.fileExtension),i=createContents(e);e.length?fs.access(t,fs.constants.R_OK,function(e){e?fs.writeFile(t,i,function(e){if(e)throw console.log("Cannot write "+t+" file."),e}):fs.readFile(t,"utf8",function(e,n){if(e)throw console.log("Cannot read "+t+" file."),e;compareContents(i,n)||fs.writeFile(t,i,function(e){if(e)throw console.log("Cannot write "+t+" files."),e})})}):fs.access(t,fs.constants.F_OK,function(e){e||fs.unlink(t,function(e){if(e)throw console.log("Cannot unlink "+t+" file."),e})})})}function getConfig(e,t){glob((e||"./**")+"/.esm-indexrc.json",function(e,n){if(e)throw console.log("Failed to read files."),e;t(n)})}function getHash(e){return crypto.createHash("md5").update(e.split("\r\n").map(function(e){return/^\/\//.test(e)?"":e}).join()).digest("hex")}function getModules(e,s,i){var a=path.dirname(e);fs.readdir(a,function(e,n){if(e)throw console.log("Cannot read "+a+" directory."),e;var t=n.map(function(r){return new es6_promise_1.Promise(function(i,o){fs.stat(path.join(a,r),function(e,n){if(e&&o(e),n.isDirectory())s.recursiveSearch?getConfig(path.join(a,r),function(e){e.length?getOptions(e[0],function(n){getModules(e[0],n,function(e){e.length?i({isIndex:!0,name:path.basename(r,"."+n.fileExtension)}):i(null)})}):i(null)}):i(null);else{var t=!0;[/\.d\.ts$/,new RegExp("\\.(?:spec|test)\\."+s.fileExtension),new RegExp("^"+s.fileName+"\\."+s.fileExtension)].concat(s.ignoreFiles.map(function(e){return new RegExp(/^\//.test(e)?e.substring(1,e.length-1):"^"+path.basename(e,"."+s.fileExtension)+"\\."+s.fileExtension)})).forEach(function(e){new RegExp("\\."+s.fileExtension+"$").test(r)&&!e.test(r)||t&&(t=!1)}),i(t?{isIndex:!1,name:path.basename(r,"."+s.fileExtension)}:null)}})})});es6_promise_1.Promise.all(t).then(function(e){var n=e.filter(function(e){return null!==e});i(n.sort(function(e,n){return e.isIndex?-1:n.isIndex?1:e.name<n.name?-1:e.name>n.name?1:0}))}).catch(function(e){if(e)throw console.log("Failed to read files."),e})})}function getOptions(t,i){fs.readFile(t,"utf8",function(e,n){if(e)throw console.log("Cannot read "+t+" file."),e;i(Object.assign({fileExtension:args.ext||"js",fileName:args.name||"index",ignoreFiles:[],recursiveSearch:!0},JSON.parse(n||"{}")))})}getConfig(args._[0],function(e){e.forEach(function(n){getOptions(n,function(e){createFile(n,e),args.watch&&chokidar.watch(path.dirname(n),{ignored:[!new RegExp("\\.(?:"+e.fileExtension+"|json)$"),e.fileName+"."+e.fileExtension]}).on("all",function(){createFile(n,e)})})})});